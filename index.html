<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FinanzApp">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='22'/><text x='50' y='62' font-family='Arial' font-size='40' font-weight='bold' fill='%2300d4aa' text-anchor='middle'>F</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>FinanzApp</title>
    <style>
        :root {
            --primary: #00d4aa;
            --primary-dark: #00b894;
            --secondary: #6c5ce7;
            --accent: #fd79a8;
            --danger: #ff6b6b;
            --warning: #ffeaa7;
            --success: #00d4aa;
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-elevated: #252542;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2d2d44;
            --glass: rgba(255,255,255,0.05);
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --glow: 0 0 20px rgba(0,212,170,0.3);
        }
        .light-mode {
            --bg-dark: #f8f9fa;
            --bg-card: #ffffff;
            --bg-elevated: #f0f0f5;
            --text-primary: #1a1a2e;
            --text-secondary: #666680;
            --border: #e0e0e8;
            --glass: rgba(0,0,0,0.05);
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100dvh;
            max-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background: var(--bg-card);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 16px; color: white;
        }
        .logo h1 { font-size: 18px; font-weight: 700; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }
        .icon-btn:hover { background: var(--primary); transform: scale(1.05); }
        nav {
            display: flex;
            background: var(--bg-card);
            padding: 8px;
            gap: 6px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            overflow-x: auto;
        }
        .nav-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 70px;
        }
        .nav-btn span { font-size: 18px; }
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--glow);
        }
        main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
        }
        .section { display: none; }
        .section.active { display: block; }
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
        .balance-card { text-align: center; padding: 20px; }
        .balance-card small { color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; }
        .balance-card h2 { font-size: 32px; margin-top: 6px; font-weight: 700; color: var(--primary); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { text-align: center; padding: 16px 12px; }
        .stat-card h3 { font-size: 22px; margin-bottom: 4px; font-weight: 700; }
        .stat-card small { color: var(--text-secondary); font-size: 10px; text-transform: uppercase; }
        .stat-card.income h3 { color: var(--success); }
        .stat-card.expense h3 { color: var(--danger); }
        .sub-tabs {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 12px;
            gap: 4px;
            flex-wrap: wrap;
        }
        .sub-tab {
            flex: 1;
            min-width: 60px;
            padding: 8px 6px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
            border: none;
            background: transparent;
        }
        .sub-tab.active {
            background: var(--bg-card);
            color: var(--primary);
        }
        .sub-content { display: none; }
        .sub-content.active { display: block; }
        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        .expandable-header h3 { font-size: 14px; font-weight: 600; }
        .expandable-content {
            display: none;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        .expandable-content.active { display: block; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 14px;
        }
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); }
        .amount-display {
            text-align: center;
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .amount-display h2 { font-size: 36px; font-weight: 700; }
        .amount-display.expense h2 { color: var(--danger); }
        .amount-display.income h2 { color: var(--success); }
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .quick-amount {
            padding: 10px;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        .quick-amount:hover, .quick-amount.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .category-btn {
            padding: 10px 8px;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s;
        }
        .category-btn:hover, .category-btn.selected {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .category-item span { font-size: 13px; }
        .category-item-actions { display: flex; gap: 8px; }
        .category-item-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
        }
        .wallet-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 10px;
            color: white;
        }
        .wallet-card h4 { font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
        .wallet-card h3 { font-size: 24px; font-weight: 700; }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .transaction-info h4 { font-size: 14px; margin-bottom: 2px; }
        .transaction-info small { color: var(--text-secondary); font-size: 11px; }
        .transaction-amount { font-weight: 700; font-size: 15px; }
        .transaction-amount.expense { color: var(--danger); }
        .transaction-amount.income { color: var(--success); }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 12px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-elevated);
        }
        .calendar-day.today { background: var(--primary); color: white; }
        .calendar-day.has-event { border: 2px solid var(--accent); }
        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .notification-item .info h4 { font-size: 13px; margin-bottom: 2px; }
        .notification-item .info small { color: var(--text-secondary); font-size: 11px; }
        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch::after {
            content: '';
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .toggle-switch.active::after { left: 22px; }
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }
        .empty-state span { font-size: 40px; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">F</div>
            <h1>FinanzApp</h1>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTheme()">üåô</button>
        </div>
    </header>
    <nav>
        <button class="nav-btn" onclick="showSection('finanzas', this)"><span>üìä</span>Finanzas</button>
        <button class="nav-btn active" onclick="showSection('transacciones', this)"><span>üí∞</span>Transacciones</button>
        <button class="nav-btn" onclick="showSection('carteras', this)"><span>üí≥</span>Carteras</button>
        <button class="nav-btn" onclick="showSection('turnos', this)"><span>üìÖ</span>Turnos</button>
    </nav>
    <main>
        <!-- FINANZAS SECTION -->
        <section id="finanzas" class="section">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="showFinanzasTab('ia')">ü§ñ IA</button>
                <button class="sub-tab" onclick="showFinanzasTab('gastos')">üìä Gastos</button>
                <button class="sub-tab" onclick="showFinanzasTab('ultimas')">üìù √öltimas</button>
                <button class="sub-tab" onclick="showFinanzasTab('ajustes')">‚öôÔ∏è Ajustes</button>
            </div>
            <div id="finanzas-ia" class="sub-content active">
                <div class="card balance-card">
                    <small>Balance Total</small>
                    <h2 id="total-balance">‚Ç¨0.00</h2>
                </div>
                <div class="stats-grid">
                    <div class="card stat-card income">
                        <h3 id="total-income">‚Ç¨0</h3>
                        <small>Ingresos</small>
                    </div>
                    <div class="card stat-card expense">
                        <h3 id="total-expense">‚Ç¨0</h3>
                        <small>Gastos</small>
                    </div>
                </div>
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:10px;">üí° Recomendaci√≥n IA</h3>
                    <p id="ia-recommendation" style="font-size:13px;color:var(--text-secondary);">A√±ade transacciones para recibir recomendaciones personalizadas.</p>
                </div>
            </div>
            <div id="finanzas-gastos" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üìä Gastos por Categor√≠a</h3>
                    <div id="category-breakdown"></div>
                </div>
            </div>
            <div id="finanzas-ultimas" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üìù √öltimas Transacciones</h3>
                    <div id="recent-transactions"></div>
                </div>
            </div>
            <div id="finanzas-ajustes" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üìÇ Categor√≠as de Gastos</h3>
                    <div id="expense-categories-list"></div>
                    <div class="form-group" style="margin-top:12px;">
                        <input type="text" id="new-expense-category" placeholder="Nueva categor√≠a...">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory('expense')">‚ûï A√±adir Categor√≠a</button>
                </div>
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üíµ Categor√≠as de Ingresos</h3>
                    <div id="income-categories-list"></div>
                    <div class="form-group" style="margin-top:12px;">
                        <input type="text" id="new-income-category" placeholder="Nueva categor√≠a...">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory('income')">‚ûï A√±adir Categor√≠a</button>
                </div>
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üîî Notificaciones</h3>
                    <div id="notifications-list"></div>
                    <div class="expandable-header" onclick="toggleExpandable('add-notification')">
                        <h3>‚ûï Nueva Notificaci√≥n</h3>
                        <span>‚ñº</span>
                    </div>
                    <div id="add-notification" class="expandable-content">
                        <div class="form-group">
                            <label>T√≠tulo</label>
                            <input type="text" id="notif-title" placeholder="T√≠tulo...">
                        </div>
                        <div class="form-group">
                            <label>Hora</label>
                            <input type="time" id="notif-time">
                        </div>
                        <button class="btn btn-primary" onclick="addNotification()">Guardar</button>
                    </div>
                </div>
            </div>
        </section>
        <!-- TRANSACCIONES SECTION -->
        <section id="transacciones" class="section active">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="showTransactionTab('gasto')">Gasto</button>
                <button class="sub-tab" onclick="showTransactionTab('ingreso')">Ingreso</button>
                <button class="sub-tab" onclick="showTransactionTab('suscripciones')">Suscripciones</button>
            </div>
            <div id="trans-gasto" class="sub-content active">
                <div class="amount-display expense">
                    <h2 id="expense-amount">‚Ç¨0.00</h2>
                </div>
                <div class="form-group">
                    <input type="text" id="expense-name" placeholder="Nombre del gasto...">
                </div>
                <div class="quick-amounts">
                    <div class="quick-amount" onclick="addQuickAmount('expense', 5)">+5‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('expense', 10)">+10‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('expense', 20)">+20‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('expense', 50)">+50‚Ç¨</div>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <div id="expense-category-buttons" class="category-buttons"></div>
                </div>
                <input type="hidden" id="expense-category" value="">
                <button class="btn btn-danger" onclick="saveExpense()">üí∏ Guardar Gasto</button>
            </div>
            <div id="trans-ingreso" class="sub-content">
                <div class="amount-display income">
                    <h2 id="income-amount">‚Ç¨0.00</h2>
                </div>
                <div class="form-group">
                    <input type="text" id="income-name" placeholder="Nombre del ingreso...">
                </div>
                <div class="quick-amounts">
                    <div class="quick-amount" onclick="addQuickAmount('income', 50)">+50‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('income', 100)">+100‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('income', 200)">+200‚Ç¨</div>
                    <div class="quick-amount" onclick="addQuickAmount('income', 500)">+500‚Ç¨</div>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <div id="income-category-buttons" class="category-buttons"></div>
                </div>
                <input type="hidden" id="income-category" value="">
                <button class="btn btn-primary" onclick="saveIncome()">üí∞ Guardar Ingreso</button>
            </div>
            <div id="trans-suscripciones" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üîÑ Suscripciones Activas</h3>
                    <div id="subscriptions-list"></div>
                </div>
                <div class="expandable-header" onclick="toggleExpandable('add-subscription')">
                    <h3>‚ûï Nueva Suscripci√≥n</h3>
                    <span>‚ñº</span>
                </div>
                <div id="add-subscription" class="expandable-content">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="sub-name" placeholder="Netflix, Spotify...">
                    </div>
                    <div class="form-group">
                        <label>Importe mensual (‚Ç¨)</label>
                        <input type="number" id="sub-amount" placeholder="9.99">
                    </div>
                    <div class="form-group">
                        <label>D√≠a de cobro</label>
                        <input type="number" id="sub-day" min="1" max="31" placeholder="15">
                    </div>
                    <button class="btn btn-primary" onclick="addSubscription()">Guardar</button>
                </div>
            </div>
        </section>
        <!-- CARTERAS SECTION -->
        <section id="carteras" class="section">
            <div class="card">
                <h3 style="font-size:14px;margin-bottom:12px;">üí≥ Mis Carteras</h3>
                <div id="wallets-list"></div>
            </div>
            <div class="expandable-header" onclick="toggleExpandable('new-wallet')">
                <h3>‚ûï Nueva Cartera</h3>
                <span>‚ñº</span>
            </div>
            <div id="new-wallet" class="expandable-content">
                <div class="form-group">
                    <label>Nombre de la cartera</label>
                    <input type="text" id="wallet-name" placeholder="Mi cartera...">
                </div>
                <div class="form-group">
                    <label>Saldo inicial (‚Ç¨)</label>
                    <input type="number" id="wallet-balance" placeholder="0.00">
                </div>
                <button class="btn btn-primary" onclick="addWallet()">Crear Cartera</button>
            </div>
            <div class="expandable-header" onclick="toggleExpandable('transfer')">
                <h3>üîÑ Transferencia</h3>
                <span>‚ñº</span>
            </div>
            <div id="transfer" class="expandable-content">
                <div class="form-group">
                    <label>Desde</label>
                    <select id="transfer-from"></select>
                </div>
                <div class="form-group">
                    <label>Hacia</label>
                    <select id="transfer-to"></select>
                </div>
                <div class="form-group">
                    <label>Cantidad (‚Ç¨)</label>
                    <input type="number" id="transfer-amount" placeholder="0.00">
                </div>
                <button class="btn btn-primary" onclick="makeTransfer()">Transferir</button>
            </div>
        </section>
        <!-- TURNOS SECTION -->
        <section id="turnos" class="section">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="showTurnosTab('calendario')">Calendario</button>
                <button class="sub-tab" onclick="showTurnosTab('cumples')">Cumplea√±os</button>
                <button class="sub-tab" onclick="showTurnosTab('notas')">Notas</button>
            </div>
            <div id="turnos-calendario" class="sub-content active">
                <div class="card">
                    <h3 id="calendar-month" style="font-size:14px;margin-bottom:12px;text-align:center;"></h3>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
                <div class="expandable-header" onclick="toggleExpandable('add-event')">
                    <h3>‚ûï Nuevo Evento</h3>
                    <span>‚ñº</span>
                </div>
                <div id="add-event" class="expandable-content">
                    <div class="form-group">
                        <label>T√≠tulo</label>
                        <input type="text" id="event-title" placeholder="Evento...">
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="event-date">
                    </div>
                    <button class="btn btn-primary" onclick="addEvent()">Guardar</button>
                </div>
            </div>
            <div id="turnos-cumples" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üéÇ Pr√≥ximos Cumplea√±os</h3>
                    <div id="birthdays-list"></div>
                </div>
                <div class="expandable-header" onclick="toggleExpandable('add-birthday')">
                    <h3>‚ûï Nuevo Cumplea√±os</h3>
                    <span>‚ñº</span>
                </div>
                <div id="add-birthday" class="expandable-content">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="birthday-name" placeholder="Nombre...">
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="birthday-date">
                    </div>
                    <button class="btn btn-primary" onclick="addBirthday()">Guardar</button>
                </div>
            </div>
            <div id="turnos-notas" class="sub-content">
                <div class="card">
                    <h3 style="font-size:14px;margin-bottom:12px;">üìù Mis Notas</h3>
                    <div id="notes-list"></div>
                </div>
                <div class="expandable-header" onclick="toggleExpandable('add-note')">
                    <h3>‚ûï Nueva Nota</h3>
                    <span>‚ñº</span>
                </div>
                <div id="add-note" class="expandable-content">
                    <div class="form-group">
                        <label>T√≠tulo</label>
                        <input type="text" id="note-title" placeholder="T√≠tulo...">
                    </div>
                    <div class="form-group">
                        <label>Contenido</label>
                        <textarea id="note-content" rows="3" placeholder="Escribe aqu√≠..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addNote()">Guardar</button>
                </div>
            </div>
        </section>
    </main>
    <script>
        // DEFAULT STATE - will be merged with saved data
        const defaultState = {
            balance: 0,
            transactions: [],
            wallets: [],
            subscriptions: [],
            events: [],
            birthdays: [],
            notes: [],
            notifications: [],
            expenseCategories: ['Comida', 'Transporte', 'Salud', 'Ocio', 'Hogar', 'Otros'],
            incomeCategories: ['Salario', 'Freelance', 'Inversiones', 'Regalos', 'Otros'],
            currentExpenseAmount: 0,
            currentIncomeAmount: 0,
            selectedExpenseCategory: '',
            selectedIncomeCategory: '',
            darkMode: true
        };
        
        let state = JSON.parse(JSON.stringify(defaultState));
        
        // IMPROVED loadState - preserves ALL existing data
        function loadState() {
            try {
                const saved = localStorage.getItem('finanzAppState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge: keep all saved data, only add missing fields from default
                    Object.keys(defaultState).forEach(key => {
                        if (parsed.hasOwnProperty(key)) {
                            // Use saved value if it exists
                            state[key] = parsed[key];
                        }
                        // If key doesn't exist in saved, keep default
                    });
                    // Also preserve any extra fields from saved data
                    Object.keys(parsed).forEach(key => {
                        if (!state.hasOwnProperty(key)) {
                            state[key] = parsed[key];
                        }
                    });
                    console.log('State loaded successfully:', state);
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
        }
        
        function saveState() {
            try {
                localStorage.setItem('finanzAppState', JSON.stringify(state));
                console.log('State saved successfully');
            } catch (e) {
                console.error('Error saving state:', e);
            }
        }
        
        function toggleTheme() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('light-mode', !state.darkMode);
            saveState();
        }
        function showSection(sectionId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            btn.classList.add('active');
        }
        function showFinanzasTab(tab) {
            document.querySelectorAll('#finanzas .sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#finanzas .sub-content').forEach(c => c.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            document.getElementById('finanzas-' + tab).classList.add('active');
        }
        function showTransactionTab(tab) {
            document.querySelectorAll('#transacciones .sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#transacciones .sub-content').forEach(c => c.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            else document.querySelector('#transacciones .sub-tab').classList.add('active');
            document.getElementById('trans-' + tab).classList.add('active');
        }
        function showTurnosTab(tab) {
            document.querySelectorAll('#turnos .sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#turnos .sub-content').forEach(c => c.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            document.getElementById('turnos-' + tab).classList.add('active');
        }
        function toggleExpandable(id) {
            document.getElementById(id).classList.toggle('active');
        }
        function addQuickAmount(type, amount) {
            if (type === 'expense') {
                state.currentExpenseAmount += amount;
                document.getElementById('expense-amount').textContent = '‚Ç¨' + state.currentExpenseAmount.toFixed(2);
            } else {
                state.currentIncomeAmount += amount;
                document.getElementById('income-amount').textContent = '‚Ç¨' + state.currentIncomeAmount.toFixed(2);
            }
        }
        function selectCategory(type, category) {
            if (type === 'expense') {
                state.selectedExpenseCategory = category;
                document.getElementById('expense-category').value = category;
                document.querySelectorAll('#expense-category-buttons .category-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.textContent === category);
                });
            } else {
                state.selectedIncomeCategory = category;
                document.getElementById('income-category').value = category;
                document.querySelectorAll('#income-category-buttons .category-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.textContent === category);
                });
            }
        }
        function addCategory(type) {
            const input = document.getElementById('new-' + type + '-category');
            const name = input.value.trim();
            if (!name) return;
            if (type === 'expense') {
                if (!state.expenseCategories.includes(name)) state.expenseCategories.push(name);
            } else {
                if (!state.incomeCategories.includes(name)) state.incomeCategories.push(name);
            }
            input.value = '';
            saveState();
            updateUI();
        }
        function deleteCategory(type, category) {
            if (type === 'expense') {
                state.expenseCategories = state.expenseCategories.filter(c => c !== category);
            } else {
                state.incomeCategories = state.incomeCategories.filter(c => c !== category);
            }
            saveState();
            updateUI();
        }
        function saveExpense() {
            if (state.currentExpenseAmount <= 0) return;
            const name = document.getElementById('expense-name').value || 'Gasto';
            const category = state.selectedExpenseCategory || 'Otros';
            state.transactions.push({
                id: Date.now(), type: 'expense', amount: state.currentExpenseAmount,
                name: name, category: category, date: new Date().toISOString()
            });
            state.balance -= state.currentExpenseAmount;
            state.currentExpenseAmount = 0;
            state.selectedExpenseCategory = '';
            document.getElementById('expense-amount').textContent = '‚Ç¨0.00';
            document.getElementById('expense-name').value = '';
            saveState();
            updateUI();
        }
        function saveIncome() {
            if (state.currentIncomeAmount <= 0) return;
            const name = document.getElementById('income-name').value || 'Ingreso';
            const category = state.selectedIncomeCategory || 'Otros';
            state.transactions.push({
                id: Date.now(), type: 'income', amount: state.currentIncomeAmount,
                name: name, category: category, date: new Date().toISOString()
            });
            state.balance += state.currentIncomeAmount;
            state.currentIncomeAmount = 0;
            state.selectedIncomeCategory = '';
            document.getElementById('income-amount').textContent = '‚Ç¨0.00';
            document.getElementById('income-name').value = '';
            saveState();
            updateUI();
        }
        function addWallet() {
            const name = document.getElementById('wallet-name').value;
            const balance = parseFloat(document.getElementById('wallet-balance').value) || 0;
            if (!name) return;
            state.wallets.push({ id: Date.now(), name, balance });
            document.getElementById('wallet-name').value = '';
            document.getElementById('wallet-balance').value = '';
            toggleExpandable('new-wallet');
            saveState();
            updateUI();
        }
        function makeTransfer() {
            const from = document.getElementById('transfer-from').value;
            const to = document.getElementById('transfer-to').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value) || 0;
            if (!from || !to || from === to || amount <= 0) return;
            const fromWallet = state.wallets.find(w => w.id == from);
            const toWallet = state.wallets.find(w => w.id == to);
            if (fromWallet && toWallet && fromWallet.balance >= amount) {
                fromWallet.balance -= amount;
                toWallet.balance += amount;
                document.getElementById('transfer-amount').value = '';
                toggleExpandable('transfer');
                saveState();
                updateUI();
            }
        }
        function addSubscription() {
            const name = document.getElementById('sub-name').value;
            const amount = parseFloat(document.getElementById('sub-amount').value) || 0;
            const day = parseInt(document.getElementById('sub-day').value) || 1;
            if (!name || amount <= 0) return;
            state.subscriptions.push({ id: Date.now(), name, amount, day, active: true });
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-amount').value = '';
            document.getElementById('sub-day').value = '';
            toggleExpandable('add-subscription');
            saveState();
            updateUI();
        }
        function addNotification() {
            const title = document.getElementById('notif-title').value;
            const time = document.getElementById('notif-time').value;
            if (!title) return;
            state.notifications.push({ id: Date.now(), title, time, active: true });
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-time').value = '';
            toggleExpandable('add-notification');
            saveState();
            updateUI();
        }
        function toggleNotification(id) {
            const notif = state.notifications.find(n => n.id === id);
            if (notif) notif.active = !notif.active;
            saveState();
            updateUI();
        }
        function addEvent() {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            if (!title || !date) return;
            state.events.push({ id: Date.now(), title, date });
            document.getElementById('event-title').value = '';
            document.getElementById('event-date').value = '';
            toggleExpandable('add-event');
            saveState();
            updateUI();
        }
        function addBirthday() {
            const name = document.getElementById('birthday-name').value;
            const date = document.getElementById('birthday-date').value;
            if (!name || !date) return;
            state.birthdays.push({ id: Date.now(), name, date });
            document.getElementById('birthday-name').value = '';
            document.getElementById('birthday-date').value = '';
            toggleExpandable('add-birthday');
            saveState();
            updateUI();
        }
        function addNote() {
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            if (!title) return;
            state.notes.push({ id: Date.now(), title, content });
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            toggleExpandable('add-note');
            saveState();
            updateUI();
        }
        function renderCalendar() {
            const now = new Date();
            const month = now.toLocaleString('es', { month: 'long', year: 'numeric' });
            document.getElementById('calendar-month').textContent = month.charAt(0).toUpperCase() + month.slice(1);
            const grid = document.getElementById('calendar-grid');
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const days = ['L','M','X','J','V','S','D'];
            grid.innerHTML = days.map(d => `<div style="font-size:10px;color:var(--text-secondary);text-align:center;">${d}</div>`).join('');
            let startDay = firstDay.getDay() || 7;
            for (let i = 1; i < startDay; i++) grid.innerHTML += '<div></div>';
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const isToday = d === now.getDate();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasEvent = state.events.some(e => e.date === dateStr);
                grid.innerHTML += `<div class="calendar-day ${isToday?'today':''} ${hasEvent?'has-event':''}">${d}</div>`;
            }
        }
        function updateUI() {
            const totalIncome = state.transactions.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const totalExpense = state.transactions.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            document.getElementById('total-balance').textContent = '‚Ç¨' + state.balance.toFixed(2);
            document.getElementById('total-income').textContent = '‚Ç¨' + totalIncome.toFixed(0);
            document.getElementById('total-expense').textContent = '‚Ç¨' + totalExpense.toFixed(0);
            // Category buttons
            const expCatBtns = document.getElementById('expense-category-buttons');
            if(expCatBtns) expCatBtns.innerHTML = (state.expenseCategories || []).map(c => 
                `<div class="category-btn" onclick="selectCategory('expense','${c}')">${c}</div>`
            ).join('');
            const incCatBtns = document.getElementById('income-category-buttons');
            if(incCatBtns) incCatBtns.innerHTML = (state.incomeCategories || []).map(c => 
                `<div class="category-btn" onclick="selectCategory('income','${c}')">${c}</div>`
            ).join('');
            // Categories list in Ajustes
            document.getElementById('expense-categories-list').innerHTML = (state.expenseCategories || []).map(c => 
                `<div class="category-item"><span>${c}</span><div class="category-item-actions"><button style="background:var(--danger);color:white;" onclick="deleteCategory('expense','${c}')">Borrar</button></div></div>`
            ).join('') || '<p style="color:var(--text-secondary);font-size:12px;">Sin categor√≠as</p>';
            document.getElementById('income-categories-list').innerHTML = (state.incomeCategories || []).map(c => 
                `<div class="category-item"><span>${c}</span><div class="category-item-actions"><button style="background:var(--danger);color:white;" onclick="deleteCategory('income','${c}')">Borrar</button></div></div>`
            ).join('') || '<p style="color:var(--text-secondary);font-size:12px;">Sin categor√≠as</p>';
            // Notifications
            document.getElementById('notifications-list').innerHTML = (state.notifications || []).map(n => 
                `<div class="notification-item"><div class="info"><h4>${n.title}</h4><small>${n.time || 'Sin hora'}</small></div><div class="toggle-switch ${n.active?'active':''}" onclick="toggleNotification(${n.id})"></div></div>`
            ).join('') || '<p style="color:var(--text-secondary);font-size:12px;">Sin notificaciones</p>';
            // Recent transactions
            const recent = (state.transactions || []).slice(-5).reverse();
            document.getElementById('recent-transactions').innerHTML = recent.map(t => 
                `<div class="transaction-item"><div class="transaction-info"><h4>${t.name}</h4><small>${t.category} ‚Ä¢ ${new Date(t.date).toLocaleDateString('es')}</small></div><span class="transaction-amount ${t.type}">${t.type==='expense'?'-':'+'}$${t.amount.toFixed(2)}</span></div>`
            ).join('') || '<div class="empty-state"><span>üí∏</span><p>Sin transacciones</p></div>';
            // Category breakdown
            const expenseByCategory = {};
            (state.transactions || []).filter(t => t.type === 'expense').forEach(t => {
                expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
            });
            document.getElementById('category-breakdown').innerHTML = Object.entries(expenseByCategory).map(([cat, amt]) => 
                `<div class="transaction-item"><span>${cat}</span><span class="transaction-amount expense">-‚Ç¨${amt.toFixed(2)}</span></div>`
            ).join('') || '<div class="empty-state"><span>üìä</span><p>Sin datos</p></div>';
            // Wallets
            document.getElementById('wallets-list').innerHTML = (state.wallets || []).map(w => 
                `<div class="wallet-card"><h4>${w.name}</h4><h3>‚Ç¨${w.balance.toFixed(2)}</h3></div>`
            ).join('') || '<div class="empty-state"><span>üí≥</span><p>Sin carteras</p></div>';
            // Transfer selects
            const walletOptions = (state.wallets || []).map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            document.getElementById('transfer-from').innerHTML = '<option value="">Seleccionar...</option>' + walletOptions;
            document.getElementById('transfer-to').innerHTML = '<option value="">Seleccionar...</option>' + walletOptions;
            // Subscriptions
            document.getElementById('subscriptions-list').innerHTML = (state.subscriptions || []).map(s => 
                `<div class="transaction-item"><div class="transaction-info"><h4>${s.name}</h4><small>D√≠a ${s.day}</small></div><span class="transaction-amount expense">-‚Ç¨${s.amount.toFixed(2)}</span></div>`
            ).join('') || '<div class="empty-state"><span>üîÑ</span><p>Sin suscripciones</p></div>';
            // Birthdays
            document.getElementById('birthdays-list').innerHTML = (state.birthdays || []).map(b => 
                `<div class="transaction-item"><div class="transaction-info"><h4>üéÇ ${b.name}</h4><small>${new Date(b.date).toLocaleDateString('es', {day:'numeric',month:'long'})}</small></div></div>`
            ).join('') || '<div class="empty-state"><span>üéÇ</span><p>Sin cumplea√±os</p></div>';
            // Notes
            document.getElementById('notes-list').innerHTML = (state.notes || []).map(n => 
                `<div class="card" style="padding:12px;margin-bottom:8px;"><h4 style="font-size:13px;margin-bottom:4px;">${n.title}</h4><p style="font-size:12px;color:var(--text-secondary);">${n.content}</p></div>`
            ).join('') || '<div class="empty-state"><span>üìù</span><p>Sin notas</p></div>';
            renderCalendar();
        }
        // Initialize - DEFAULT TO GASTO TAB
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            document.body.classList.toggle('light-mode', !state.darkMode);
            updateUI();
            showSection('transacciones', document.querySelectorAll('.nav-btn')[1]);
            showTransactionTab('gasto');
        });
    </script>
</body>
</html>
